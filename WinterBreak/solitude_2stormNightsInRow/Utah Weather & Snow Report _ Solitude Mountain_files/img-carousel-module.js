define(function(require){"use strict";var $=require("jquery"),helpers=require("helpers"),dragscroll=require("dragscroll"),defaultOptions={el:undefined,itemsContainerSelector:"ul",itemsSelector:"li",imagesSelector:"img",numItemsDisplayed:5,defaultRightMargin:50,itemMaxWidthPercent:16,animationSpeed:200,autoScroll:true,autoScrollSpeedPerSlide:750,autoScrollSpeed:5e3,autoScrollDelay:1e3,useDefaultMargin:false},module={create:create};return module;function create(options){var publicInstance={},privateInstance={};privateInstance.settings=$.extend({},defaultOptions,options);privateInstance.publicInstance=publicInstance;bindMethods(privateInstance);privateInstance.cacheDom();privateInstance.applyLogoPositioning();privateInstance.initCarousel();privateInstance.attachHandlers();return publicInstance}function bindMethods(instance){instance.cacheDom=cacheDom.bind(instance);instance.mapJqueryObject=mapJqueryObject.bind(instance);instance.applyLogoPositioning=applyLogoPositioning.bind(instance);instance.applyMaxWidthToItems=applyMaxWidthToItems.bind(instance);instance.measureImagesAndSetVerticalMargins=measureImagesAndSetVerticalMargins.bind(instance);instance.measureImageAndSetMargin=measureImageAndSetMargin.bind(instance);instance.setImageMargin=setImageMargin.bind(instance);instance.measureAndAppendImageWidth=measureAndAppendImageWidth.bind(instance);instance.applyLeftMargins=applyLeftMargins.bind(instance);instance.measureItemsAndApplyWidthToContainer=measureItemsAndApplyWidthToContainer.bind(instance);instance.measureItemWidths=measureItemWidths.bind(instance);instance.startCarousel=startCarousel.bind(instance);instance.scrollOut=scrollOut.bind(instance);instance.scrollBack=scrollBack.bind(instance);instance.resetCarousel=resetCarousel.bind(instance);instance.attachHandlers=attachHandlers.bind(instance);instance.onResize=onResize.bind(instance);instance.onMousedown=onMousedown.bind(instance);instance.findNextImageMargin=findNextImageMargin.bind(instance);instance.setLogoMargins=setLogoMargins.bind(instance);instance.onMouseEnter=onMouseEnter.bind(instance);instance.initCarousel=initCarousel.bind(instance);instance.stopCarousel=stopCarousel.bind(instance);instance.onMouseLeave=onMouseLeave.bind(instance)}function cacheDom(){this.dom={};this.dom.window=$(window);this.dom.el=this.settings.el;this.dom.itemsContainer=this.settings.el.find(this.settings.itemsContainerSelector);this.dom.items=this.dom.el.find(this.settings.itemsSelector).map(this.mapJqueryObject).get();this.settings.autoScrollSpeed=this.settings.autoScrollSpeedPerSlide*this.dom.items.length}function mapJqueryObject(index,element){var $item=$(element);return{item:$item,image:$item.find(this.settings.imagesSelector)}}function applyLogoPositioning(){if(!this.dom.el.is(":visible")){return}this.applyMaxWidthToItems();this.measureImagesAndSetVerticalMargins();if(this.settings.useDefaultMargin){this.applyLeftMargins(this.settings.defaultRightMargin)}else if(this.dom.items.length>=this.settings.numItemsDisplayed){this.applyLeftMargins()}else{this.applyLeftMargins(this.settings.defaultRightMargin)}this.measureItemsAndApplyWidthToContainer()}function applyMaxWidthToItems(){var maxWidth=this.dom.el.width()*(this.settings.itemMaxWidthPercent/100),imageWidth;maxWidth=Math.floor(maxWidth);$.each(this.dom.items,function(index,item){item.item.width(maxWidth);imageWidth=item.image.width();imageWidth=Math.ceil(imageWidth);item.item.width(imageWidth)})}function measureImagesAndSetVerticalMargins(){this.totalImagesWidth=0;$.each(this.dom.items,this.measureImageAndSetMargin)}function measureImageAndSetMargin(index,item){this.setImageMargin(item.image);this.measureAndAppendImageWidth(index,item.image)}function setImageMargin($image){var height=$image.height(),halfHeight=height/2,marginTop="-"+halfHeight+"px";$image.css({"margin-top":marginTop})}function measureAndAppendImageWidth(index,$image){if(index<this.settings.numItemsDisplayed){this.totalImagesWidth+=$image.width()}}function applyLeftMargins(specifiedMargin){var i,elWidth,remainingWidth,marginWidth;if(specifiedMargin!==undefined){for(i=0;i<this.dom.items.length-1;i+=1){this.dom.items[i].item.css({"margin-right":specifiedMargin+"px"})}this.appliedMargin=specifiedMargin;return}elWidth=this.dom.el.width();remainingWidth=elWidth-this.totalImagesWidth;marginWidth=remainingWidth/(this.settings.numItemsDisplayed-1);marginWidth=Math.floor(marginWidth);marginWidth=marginWidth-1;if(marginWidth<this.settings.defaultRightMargin){marginWidth=this.settings.defaultRightMargin}for(i=0;i<this.dom.items.length-1;i+=1){this.dom.items[i].item.css({"margin-right":marginWidth+"px"})}this.appliedMargin=marginWidth}function measureItemsAndApplyWidthToContainer(){this.totalItemsWidth=0;$.each(this.dom.items,this.measureItemWidths);this.dom.itemsContainer.width(this.totalItemsWidth);if(this.totalItemsWidth<this.dom.el.width()){this.dom.itemsContainer.css({"margin-left":"auto","margin-right":"auto"})}else{this.dom.itemsContainer.css({"margin-left":"initial","margin-right":"initial"})}}function measureItemWidths(index,item){this.totalItemsWidth+=item.item.outerWidth(true)}function initCarousel(){if(this.dom.itemsContainer.width()<this.dom.el.width()&&!this.dom.el.is(":visible")){return}this.dom.el.addClass("has-carousel");this.hasCarousel=true;this.isRunning=false;this.setLogoMargins();this.offset=this.dom.itemsContainer.width()-this.dom.el.width();dragscroll.reset()}function startCarousel(){if(!this.hasCarousel||this.isRunning||!this.dom.el.is(":visible")||this.dom.itemsContainer.width()<this.dom.el.width()){return}if(this.settings.autoScroll){this.isRunning=true;this.carouselAnimationTimeout=window.setTimeout(this.scrollOut,this.settings.autoScrollDelay)}}function setLogoMargins(){var i,runningTotal;this.logoMargins=[];runningTotal=0;for(i=0;i<this.dom.items.length;i+=1){this.logoMargins.push(runningTotal);runningTotal+=this.dom.items[i].image.width()+this.appliedMargin}}function scrollOut(){var that=this;var scrollLeft=this.dom.el.scrollLeft();var multiplier=this.offset>0?1-scrollLeft/this.offset:1;var scrollDuration=this.settings.autoScrollSpeed*multiplier;this.dom.el.animate({scrollLeft:this.offset},scrollDuration,"linear",function(){that.carouselAnimationTimeout=window.setTimeout(that.scrollBack,that.settings.autoScrollDelay)})}function scrollBack(){var that=this;this.dom.el.animate({scrollLeft:0},this.settings.autoScrollSpeed,"linear",function(){that.carouselAnimationTimeout=window.setTimeout(that.scrollOut,that.settings.autoScrollDelay)})}function stopCarousel(){if(!this.hasCarousel||!this.isRunning||!this.dom.el.is(":visible")){return}this.isRunning=false;window.clearTimeout(this.carouselAnimationTimeout);this.dom.el.stop()}function resetCarousel(callback){if(!this.dom.el.is(":visible")){return}var that=this;that.stopCarousel();callback();that.initCarousel()}function findNextImageMargin(currentMargin,direction){var margin=Math.abs(currentMargin),i,rightMargin=currentMargin,leftMargin=currentMargin;for(i=0;i<this.logoMargins.length;i+=1){if(this.logoMargins[i]<margin){rightMargin=this.logoMargins[i]}else if(this.logoMargins[i]>margin){leftMargin=this.logoMargins[i];break}}if(direction==="left"){return leftMargin}return rightMargin}function onMousedown(e){this.stopCarousel()}function attachHandlers(){this.dom.window.on("resize.img-carousel",helpers.debounce(this.onResize,25,false));this.dom.el.on("mousedown.img-carousel",this.onMousedown);this.dom.el.on("mouseenter.img-carousel",this.onMouseEnter);this.dom.el.on("mouseleave.img-carousel",this.onMouseLeave)}function onResize(){this.resetCarousel(this.applyLogoPositioning)}function onMouseEnter(e){this.startCarousel()}function onMouseLeave(e){this.stopCarousel()}});