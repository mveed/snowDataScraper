define(function(require){"use strict";var $=require("jquery"),helpers=require("helpers"),mustache=require("mustache"),headerComponentModel,headerStateManager=require("header-component-manager"),dom,otherDomComponents=[],settings={animationStartingLeft:20,enableMatchHighlight:false},template=require("text!/public/Shared/templates/searchresults/predictivesearchresults.html"),sessionStorage=window.sessionStorage,minCharsPredictiveSearch=3,debounceResultsMilliseconds=0,debounceResizeMilliseconds=0,latestSearchTerm,predictiveSearchCache,langVer=document.documentElement.lang,isExactMatch,openCloseAnimations;init();function init(){cacheDom();attachHandlers();headerComponentModel=new(require("header-component-model"))(dom.searchArea,closeSearchArea,function(){return dom.searchButton.hasClass("open")});headerStateManager.register(headerComponentModel);if(helpers.isMobileOrTabletDevice()||!helpers.windowWidthsGreaterThan(1023)){dom.searchAreaMobile.addClass("open")}if(!sessionStorage.getItem("predictiveSearchCache#"+langVer)){predictiveSearchCache={};sessionStorage.setItem("predictiveSearchCache#"+langVer,"{}","/")}else{predictiveSearchCache=JSON.parse(sessionStorage.getItem("predictiveSearchCache#"+langVer))}isExactMatch=helpers.getParameterByName("isExactMatch")||helpers.getCookieByName("isExactMatch");if(isExactMatch=="true"){helpers.setCookieByPath("isExactMatch","true","/")}else{helpers.setCookieByPath("isExactMatch","false","/")}if(!helpers.isSquaw()){otherDomComponents=[dom.alerts.toggle,dom.alerts.container,dom.conditions.container]}settings.enableMatchHighlight=getEnabledMatchedPhraseHighlight();if(helpers.isSquaw()){openCloseAnimations={searchBar:new(require("header-animation"))(dom.searchArea)}}}function cacheDom(){dom={};dom.window=$(window);dom.header=$("header.main-v2");dom.searchButton=dom.header.find(".search");dom.searchArea=dom.header.find(".search-bar-v2");dom.searchAreaClose=dom.searchArea.find(".close");dom.searchQueryInput=dom.searchArea.find('input[name="query"]');dom.searchQueryForm=dom.searchArea.find("form");dom.predictiveSearchArea=dom.searchArea.find(".predictive-search-results-wrapper");dom.predictiveSearchResultsContainer=dom.predictiveSearchArea.find(".predictive-search-results");dom.quickLinksArea=dom.searchArea.find(".quick-links-wrapper");dom.alerts={};dom.alerts.toggle=dom.header.find(".alerts-toggle");dom.alerts.container=dom.header.find(".alerts-container");dom.conditions={};dom.conditions.container=dom.header.find(".condition-snippet");dom.searchAreaMobile=dom.header.find(".search-bar-v2-mobile");dom.searchAreaMobileClose=dom.searchAreaMobile.find(".close");dom.searchQueryMobileInput=dom.searchAreaMobile.find('input[name="query"]');dom.searchQueryMobileButton=dom.searchAreaMobile.find(".search-end");dom.searchQueryMobileStart=dom.searchAreaMobile.find(".search-start");dom.searchQueryFormMobile=dom.searchAreaMobile.find("form");dom.predictiveSearchAreaMobile=dom.searchAreaMobile.find(".predictive-search-results-wrapper");dom.predictiveSearchResultsMobileContainer=dom.predictiveSearchAreaMobile.find(".predictive-search-results");dom.quickLinksAreaMobile=dom.searchAreaMobile.find(".quick-links-wrapper");dom.searchBarV2Config=dom.searchArea.find(".search-bar-v2-config")}function attachHandlers(){dom.window.on("resize",helpers.debounce(resizeProcesses,debounceResizeMilliseconds,true));dom.searchButton.on("click",toggleSearchArea);dom.searchAreaClose.on("click",closeSearchArea);dom.searchQueryMobileButton.on("click",function(){submitForm(dom.searchQueryFormMobile)});dom.searchAreaMobileClose.on("click",clearMobileSearchInput);dom.searchQueryInput.on("input",helpers.debounce(togglePredictiveSearchArea,debounceResultsMilliseconds,true));dom.searchQueryInput.on("focus",togglePredictiveSearchArea);dom.searchQueryInput.on("keydown",function(e){if(e.keyCode===13){submitForm(dom.searchQueryForm)}});dom.searchQueryMobileInput.on("input",helpers.debounce(togglePredictiveSearchAreaMobile,debounceResultsMilliseconds,true));dom.searchQueryMobileInput.on("focusout",function(){closePredictiveSearchAreaMobile();closeQuickLinksMobileArea()});dom.searchQueryMobileInput.on("focus",togglePredictiveSearchAreaMobile);dom.searchQueryMobileInput.on("keydown",function(e){if(e.keyCode===13){submitForm(dom.searchQueryFormMobile)}});dom.predictiveSearchArea.find(".predictive-search-see-more").on("click",submitToSearchResultsPage);dom.predictiveSearchAreaMobile.find(".predictive-search-see-more").on("click",submitToSearchResultsPage);dom.window.unload(function(){sessionStorage.removeItem("predictiveSearchCache#"+langVer)})}function borderButtonStyles(open){if(open){dom.searchQueryMobileButton.removeClass("predictive-search-wrapper-close");dom.searchQueryMobileStart.removeClass("predictive-search-wrapper-close");dom.searchQueryMobileButton.addClass("predictive-search-wrapper-open");dom.searchQueryMobileStart.addClass("predictive-search-wrapper-open")}else{dom.searchQueryMobileButton.removeClass("predictive-search-wrapper-open");dom.searchQueryMobileStart.removeClass("predictive-search-wrapper-open");dom.searchQueryMobileButton.addClass("predictive-search-wrapper-close");dom.searchQueryMobileStart.addClass("predictive-search-wrapper-close")}}function setMobileSearchBarBorderStyles(open){if(helpers.windowWidthsGreaterThan(425)){borderButtonStyles(open)}}function resizeProcesses(){setMobileSearchBarBorderStyles(false);renderQuickLinks();updatePredictiveSearchResults()}function activeSearchArea(){return dom.searchArea.hasClass("open")?"desktop":"mobile"}function submitToSearchResultsPage(){var seeMoreResultsAnchorTag=$(this).find("a");var hrefValue=seeMoreResultsAnchorTag.attr("href");helpers.setCookieByPath("SeeMoreResultsSubmit",latestSearchTerm,"/");seeMoreResultsAnchorTag.attr("href",hrefValue+"?query="+(activeSearchArea()==="desktop"?dom.searchQueryInput.val():dom.searchQueryMobileInput.val())+(isExactMatch=="true"?"&isExactMatch=true":""))}function toggleSearchArea(e){e.preventDefault();if(dom.searchButton.hasClass("open")){submitForm(dom.searchQueryForm)}else{openSearchArea()}}function submitForm(form){if(isExactMatch=="true"){var input=$("<input>").attr("type","hidden").attr("name","isExactMatch").val("true");form.append(input)}helpers.setCookieByPath("SearchQuerySubmit",latestSearchTerm,"/");form.submit()}function openSearchArea(){dom.searchArea.css("left",settings.animationStartingLeft);if(helpers.isSquaw()){headerStateManager.closeOtherComponents(headerComponentModel.id,false);dom.searchArea.addClass("open");dom.searchButton.addClass("open");dom.searchArea.css("display","");if(dom.searchQueryInput.val().trim().length>=minCharsPredictiveSearch){closeQuickLinksArea()}else{openQuickLinksArea();renderQuickLinks()}openCloseAnimations.searchBar.open();dom.searchQueryInput.focus()}else{headerStateManager.closeOtherComponents(headerComponentModel.id,true);helpers.fadeOutElements(otherDomComponents);setTimeout(function(){helpers.hideElements(otherDomComponents);dom.searchArea.animate({left:"0"},{queue:false,duration:150});dom.searchArea.fadeIn({easing:"linear",duration:300,queue:false,complete:function(){dom.searchArea.addClass("open");dom.searchButton.addClass("open");dom.searchArea.css("display","");dom.searchQueryInput.focus();openQuickLinksArea();renderQuickLinks()}})},250)}}function closeSearchArea(){helpers.showElements(otherDomComponents);dom.searchArea.animate({left:settings.animationStartingLeft},{queue:false,duration:380});dom.searchArea.fadeOut({easing:"linear",duration:250,queue:false,complete:function(){dom.searchArea.removeClass("open");helpers.fadeInElements(otherDomComponents,200)}});dom.searchButton.removeClass("open");if(dom.predictiveSearchArea.hasClass("open")){closePredictiveSearchArea()}if(helpers.isSquaw()){openCloseAnimations.searchBar.close()}}function showButton(){if(dom.searchQueryMobileInput[0].value===""){dom.searchQueryMobileButton.removeClass("active");dom.searchAreaMobileClose.addClass("hidden")}else{dom.searchQueryMobileButton.addClass("active");dom.searchAreaMobileClose.removeClass("hidden")}}function clearMobileSearchInput(event){event.preventDefault();dom.searchQueryMobileInput[0].value="";dom.searchQueryMobileInput.focus()}function togglePredictiveSearchArea(){if(event.currentTarget.value.trim().length>=minCharsPredictiveSearch){if(dom.quickLinksArea.hasClass("open")){closeQuickLinksArea()}if(!dom.predictiveSearchArea.hasClass("open")){openPredictiveSearchArea()}updatePredictiveSearchResults()}else{if(dom.predictiveSearchArea.hasClass("open")){closePredictiveSearchArea()}openQuickLinksArea()}}function togglePredictiveSearchAreaMobile(){if(event){var numChars=event.currentTarget.value.trim().length;if(numChars>=0){showButton()}if(numChars>=minCharsPredictiveSearch){if(dom.quickLinksAreaMobile.hasClass("open")){closeQuickLinksMobileArea()}if(!dom.predictiveSearchAreaMobile.hasClass("open")){openPredictiveSearchAreaMobile()}setMobileSearchBarBorderStyles(true);updatePredictiveSearchResults()}else{if(dom.predictiveSearchAreaMobile.hasClass("open")){closePredictiveSearchAreaMobile()}openQuickLinksMobileArea();renderQuickLinks()}}}function openPredictiveSearchArea(){dom.predictiveSearchArea.fadeIn({easing:"linear",duration:100,queue:true,complete:function(){dom.predictiveSearchArea.addClass("open");helpers.moveCursorToEnd(dom.searchQueryInput[0])}})}function openPredictiveSearchAreaMobile(){dom.predictiveSearchAreaMobile.fadeIn({easing:"linear",duration:100,queue:true,complete:function(){dom.predictiveSearchAreaMobile.addClass("open");helpers.moveCursorToEnd(dom.searchQueryMobileInput[0]);setMobileSearchBarBorderStyles(true);dom.searchQueryFormMobile.addClass("open")}})}function closePredictiveSearchArea(){dom.predictiveSearchArea.fadeOut({easing:"linear",duration:150,queue:false,complete:function(){dom.predictiveSearchArea.removeClass("open")}})}function closePredictiveSearchAreaMobile(){dom.predictiveSearchAreaMobile.fadeOut({easing:"linear",duration:150,queue:false,complete:function(){dom.predictiveSearchAreaMobile.removeClass("open");setMobileSearchBarBorderStyles(false);dom.searchQueryFormMobile.removeClass("open")}})}function openQuickLinksArea(){dom.quickLinksArea.fadeIn({easing:"linear",duration:100,queue:true,complete:function(){dom.quickLinksArea.addClass("open")}})}function closeQuickLinksArea(){dom.quickLinksArea.fadeOut({easing:"linear",duration:150,queue:false,complete:function(){dom.quickLinksArea.removeClass("open")}})}function openQuickLinksMobileArea(){dom.quickLinksAreaMobile.fadeIn({easing:"linear",duration:100,queue:true,complete:function(){dom.quickLinksAreaMobile.addClass("open");setMobileSearchBarBorderStyles(true);dom.searchQueryFormMobile.addClass("open")}})}function closeQuickLinksMobileArea(){dom.quickLinksAreaMobile.fadeOut({easing:"linear",duration:150,queue:false,complete:function(){dom.quickLinksAreaMobile.removeClass("open");setMobileSearchBarBorderStyles(false);dom.searchQueryFormMobile.removeClass("open")}})}function renderQuickLinks(){$(".quick-link").each(function(){var elem=$(this);var title=elem.find(".quick-link-result-title"),description=elem.find(".quick-link-result-description");title.text(title.data("default"));description.text(description.data("default"));helpers.ellipsisText(title,31);helpers.ellipsisText(description,31);elem.click(function(){helpers.setCookieByPath("QuickLinksClicked",elem.find("a > span").data("default"),"/")})})}function renderPredictiveSearchResults(results,searchArea,resultsContainer){if(results.length>4){searchArea.find(".predictive-search-see-more").css("display","block")}else{searchArea.find(".predictive-search-see-more").css("display","none")}var resultsHtml=mustache.render(template,{results:results.slice(0,4)});resultsContainer.html(resultsHtml);$(".predictive-search-result .predictive-search-result-wrapper-link").each(function(){var elem=$(this);var title=elem.find(".predictive-search-result-title"),description=elem.find(".predictive-search-result-description");helpers.ellipsisText(title,31);helpers.ellipsisText(description,31);if(settings.enableMatchHighlight){highlightText(title,latestSearchTerm);highlightText(description,latestSearchTerm)}elem.click(function(){helpers.setCookieByPath("PredictiveSearchQuery",latestSearchTerm,"/")})});dom.searchQueryFormMobile.addClass("open")}function loadPredictiveSearchResults(payload,searchArea,resultsContainer){if(predictiveSearchCache.hasOwnProperty(latestSearchTerm)){renderPredictiveSearchResults(predictiveSearchCache[latestSearchTerm],searchArea,resultsContainer)}else{$.ajax({type:"GET",url:"/searchapi/PredictiveSearch/GetSearchResults",data:payload,dataType:"json",cache:false,headers:{"cache-control":"no-cache"},async:true,contentType:"application/json; charset=utf-8",success:function(res){if(res.SearchTerm===latestSearchTerm){renderPredictiveSearchResults(res.Results,searchArea,resultsContainer);predictiveSearchCache[res.SearchTerm]=res.Results;sessionStorage.setItem("predictiveSearchCache#"+langVer,JSON.stringify(predictiveSearchCache))}}})}}function updatePredictiveSearchResults(){var payload;if(activeSearchArea()==="desktop"&&!helpers.checkInputIfNullOrWhiteSpace(dom.searchQueryInput)){latestSearchTerm=dom.searchQueryInput.val().trim();payload={term:latestSearchTerm,requestStartTime:Date.now()};if(isExactMatch=="true"){payload.isExactMatch=true}loadPredictiveSearchResults(payload,dom.predictiveSearchArea,dom.predictiveSearchResultsContainer)}else if(activeSearchArea()==="mobile"&&!helpers.checkInputIfNullOrWhiteSpace(dom.searchQueryMobileInput)){latestSearchTerm=dom.searchQueryMobileInput.val().trim();payload={term:latestSearchTerm,requestStartTime:Date.now()};if(isExactMatch=="true"){payload.isExactMatch=true}loadPredictiveSearchResults(payload,dom.predictiveSearchAreaMobile,dom.predictiveSearchResultsMobileContainer)}}function highlightText(textElement,termToHighlight){var text=textElement.text();var resultText=text.replace(new RegExp(termToHighlight.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"gi"),function(match){return"<mark>"+match+"</mark>"});textElement.html(resultText)}function getEnabledMatchedPhraseHighlight(){if(dom.searchBarV2Config){var config=JSON.parse(dom.searchBarV2Config.text());return config.isEnabledMatchedPhraseHighlight}return false}});